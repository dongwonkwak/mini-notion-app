---
inclusion: fileMatch
fileMatchPattern: "**/prisma/**"
---

# PostgreSQL + Prisma 데이터베이스 설계 가이드

미니 노션의 데이터베이스 아키텍처 설계를 위한 포괄적인 가이드라인입니다. Y.js 기반 실시간 협업, 계층적 워크스페이스 구조, 세밀한 권한 시스템을 지원하는 확장 가능한 데이터베이스 설계 원칙을 정의합니다.

## Y.js 바이너리 데이터 저장 패턴

### CRDT 문서 저장 전략

**바이너리 데이터 저장 구조**
- Y.js 문서는 PostgreSQL의 BYTEA 타입으로 저장
- 문서 상태와 업데이트 델타를 분리하여 저장
- 압축된 바이너리 형태로 저장 공간 최적화
- 문서 버전별 스냅샷과 증분 업데이트 구분

**문서 메타데이터 관리**
- 문서 ID, 생성/수정 시간, 크기 정보 별도 관리
- 문서 상태 추적 (활성, 보관, 삭제) 필드
- 마지막 동기화 시간 및 체크섬 정보
- 협업 세션 정보 및 활성 사용자 추적

**성능 최적화 고려사항**
- 대용량 문서의 청크 단위 분할 저장
- 자주 접근하는 문서의 캐싱 전략
- 오래된 버전의 자동 정리 정책
- 읽기 전용 복제본을 통한 부하 분산

### 실시간 동기화 지원

**업데이트 로그 관리**
- 모든 문서 변경사항을 시간순으로 기록
- 클라이언트별 마지막 동기화 포인트 추적
- 충돌 해결을 위한 벡터 클록 정보 저장
- 네트워크 단절 시 재동기화를 위한 델타 보관

**협업 세션 추적**
- 활성 편집 세션 및 사용자 커서 위치
- 실시간 awareness 정보 (선택 영역, 포커스)
- 세션 타임아웃 및 정리 메커니즘
- 동시 편집자 수 제한 및 관리

**데이터 일관성 보장**
- 트랜잭션을 통한 원자적 업데이트
- 낙관적 잠금을 통한 동시성 제어
- 데이터 무결성 검증 및 복구 메커니즘
- 백업 및 복원 시 일관성 유지

## 워크스페이스/페이지 계층 구조 모델링

### 계층적 구조 설계

**트리 구조 모델링 패턴**
- Nested Set Model 또는 Adjacency List 패턴 선택
- 무제한 깊이의 중첩 구조 지원
- 효율적인 하위 트리 조회를 위한 경로 인덱싱
- 순서 정보를 위한 정렬 필드 관리

**워크스페이스 격리**
- 워크스페이스별 완전한 데이터 격리
- 크로스 워크스페이스 참조 방지
- 워크스페이스 단위 백업 및 복원
- 멀티 테넌시 지원을 위한 파티셔닝

**페이지 관계 관리**
- 부모-자식 관계의 명확한 정의
- 페이지 이동 시 하위 페이지 일괄 처리
- 순환 참조 방지 메커니즘
- 삭제된 페이지의 복구 가능한 보관

### 메타데이터 및 속성 관리

**페이지 속성 시스템**
- 동적 속성을 위한 JSON 필드 활용
- 타입별 속성 검증 및 인덱싱
- 속성 기반 검색 및 필터링 지원
- 속성 변경 히스토리 추적

**템플릿 및 상속**
- 페이지 템플릿 시스템 지원
- 상위 페이지로부터 속성 상속
- 템플릿 변경 시 하위 페이지 일괄 업데이트
- 커스텀 속성 스키마 정의

**버전 관리**
- 페이지 구조 변경 히스토리 추적
- 특정 시점으로의 구조 복원 기능
- 변경 사항의 diff 및 병합 지원
- 구조 변경의 영향 범위 분석

## 권한 시스템 스키마 설계

### 역할 기반 접근 제어 (RBAC)

**역할 계층 구조**
- Owner, Admin, Editor, Viewer 등 기본 역할 정의
- 역할 간 상속 관계 및 권한 위임
- 커스텀 역할 생성 및 권한 조합
- 역할별 기본 권한 템플릿 제공

**권한 세분화**
- 리소스별 세밀한 권한 정의 (읽기, 쓰기, 삭제, 공유)
- 페이지 레벨 및 블록 레벨 권한 구분
- 시간 제한 권한 및 조건부 접근
- 권한 상속 및 오버라이드 규칙

**동적 권한 평가**
- 런타임 권한 검증 최적화
- 권한 캐싱 및 무효화 전략
- 대량 권한 검사의 배치 처리
- 권한 변경 시 실시간 반영

### 공유 및 협업 권한

**공유 링크 관리**
- 공개/비공개 링크 생성 및 관리
- 링크별 권한 레벨 설정
- 링크 만료 시간 및 사용 횟수 제한
- 링크 접근 로그 및 분석

**팀 및 그룹 권한**
- 사용자 그룹 기반 권한 관리
- 그룹 멤버십 동적 관리
- 그룹 권한과 개별 권한의 조합
- 그룹 권한 변경의 일괄 적용

**외부 사용자 관리**
- 게스트 사용자 임시 접근 권한
- 이메일 기반 초대 시스템
- 외부 사용자 활동 추적 및 제한
- 보안 정책 준수를 위한 감사 로그

## 성능 최적화를 위한 인덱스 전략

### 쿼리 패턴 기반 인덱싱

**계층 구조 쿼리 최적화**
- 경로 기반 인덱스로 하위 트리 조회 최적화
- 부분 인덱스를 통한 활성 페이지만 인덱싱
- 복합 인덱스로 정렬 및 필터링 동시 지원
- 함수 기반 인덱스로 계산된 값 최적화

**전문 검색 인덱스**
- PostgreSQL Full-Text Search 활용
- 다국어 검색을 위한 언어별 인덱스
- 가중치 기반 검색 결과 랭킹
- 검색 성능 향상을 위한 GIN 인덱스

**시계열 데이터 인덱싱**
- 시간 기반 파티셔닝으로 성능 향상
- 최근 데이터 우선 인덱싱 전략
- 오래된 데이터의 압축 및 아카이빙
- 시간 범위 쿼리 최적화

### 인덱스 유지보수

**인덱스 모니터링**
- 인덱스 사용률 및 효율성 추적
- 중복 인덱스 탐지 및 정리
- 인덱스 크기 및 성장률 모니터링
- 쿼리 실행 계획 분석 자동화

**동적 인덱스 관리**
- 사용 패턴에 따른 인덱스 자동 생성
- 사용되지 않는 인덱스 자동 제거
- 인덱스 재구성 및 최적화 스케줄링
- 인덱스 변경의 영향도 분석

**파티셔닝 전략**
- 워크스페이스별 테이블 파티셔닝
- 시간 기반 파티셔닝으로 성능 향상
- 파티션 프루닝을 통한 쿼리 최적화
- 파티션 관리 자동화

## Prisma 마이그레이션 관리

### 마이그레이션 전략

**스키마 변경 관리**
- 점진적 마이그레이션을 통한 무중단 배포
- 하위 호환성 유지를 위한 단계적 변경
- 롤백 가능한 마이그레이션 설계
- 마이그레이션 실행 전 검증 단계

**데이터 마이그레이션**
- 대용량 데이터 마이그레이션 배치 처리
- 마이그레이션 중 데이터 일관성 보장
- 마이그레이션 진행률 추적 및 모니터링
- 실패 시 자동 롤백 메커니즘

**환경별 마이그레이션**
- 개발/스테이징/프로덕션 환경 일관성
- 환경별 마이그레이션 실행 순서 관리
- 마이그레이션 충돌 해결 전략
- 환경 간 스키마 동기화 검증

### 버전 관리 및 협업

**마이그레이션 파일 관리**
- 의미 있는 마이그레이션 파일명 규칙
- 마이그레이션 설명 및 문서화 표준
- 브랜치별 마이그레이션 충돌 해결
- 마이그레이션 히스토리 추적

**팀 협업 가이드라인**
- 마이그레이션 생성 및 리뷰 프로세스
- 스키마 변경 영향도 분석 의무화
- 마이그레이션 테스트 자동화
- 프로덕션 배포 전 검증 체크리스트

**백업 및 복구**
- 마이그레이션 실행 전 자동 백업
- 포인트 인 타임 복구 지원
- 마이그레이션 실패 시 복구 절차
- 백업 데이터 검증 및 테스트

## TestContainers와 일치하는 스키마 검증

### 테스트 환경 일관성

**컨테이너 기반 테스트**
- 프로덕션과 동일한 PostgreSQL 버전 사용
- 테스트용 데이터베이스 초기화 스크립트
- 테스트 간 데이터 격리 및 정리
- 병렬 테스트 실행을 위한 데이터베이스 분리

**스키마 검증 자동화**
- 마이그레이션 실행 후 스키마 일관성 검증
- 인덱스 및 제약조건 존재 여부 확인
- 테스트 데이터 생성 및 검증
- 성능 테스트를 위한 대용량 데이터 생성

**통합 테스트 지원**
- 실제 데이터베이스 연산 테스트
- 트랜잭션 및 동시성 테스트
- 데이터 무결성 제약조건 검증
- 복잡한 쿼리 성능 테스트

### 데이터 시드 및 픽스처

**테스트 데이터 관리**
- 재사용 가능한 테스트 데이터 팩토리
- 테스트 시나리오별 데이터 세트
- 개인정보 보호를 위한 더미 데이터 생성
- 테스트 데이터 일관성 검증

**성능 테스트 데이터**
- 대용량 데이터 생성 스크립트
- 실제 사용 패턴을 반영한 데이터 분포
- 성능 벤치마크를 위한 기준 데이터
- 메모리 및 디스크 사용량 최적화

**데이터 정리 전략**
- 테스트 완료 후 자동 데이터 정리
- 테스트 간 데이터 오염 방지
- 트랜잭션 롤백을 통한 빠른 정리
- 정리 실패 시 대체 정리 메커니즘

## 보안 및 감사

### 데이터 보안

**암호화 전략**
- 민감한 데이터의 컬럼 레벨 암호화
- 전송 중 데이터 암호화 (TLS)
- 저장 데이터 암호화 (Transparent Data Encryption)
- 암호화 키 관리 및 순환 정책

**접근 제어**
- 데이터베이스 사용자별 최소 권한 원칙
- 애플리케이션별 데이터베이스 계정 분리
- 연결 풀링 및 연결 제한 관리
- IP 기반 접근 제한 및 방화벽 규칙

**데이터 마스킹**
- 개발/테스트 환경에서 민감 데이터 마스킹
- 로그 및 에러 메시지에서 민감 정보 제거
- 데이터 익스포트 시 자동 마스킹
- 마스킹 규칙의 정기적 검토 및 업데이트

### 감사 및 모니터링

**감사 로그**
- 모든 데이터 변경 사항 추적
- 사용자별 데이터 접근 로그
- 권한 변경 및 관리 작업 기록
- 감사 로그의 무결성 보장

**성능 모니터링**
- 쿼리 성능 및 실행 계획 추적
- 데이터베이스 리소스 사용률 모니터링
- 슬로우 쿼리 탐지 및 최적화 제안
- 용량 증가 추세 분석 및 예측

**알림 및 대응**
- 임계치 초과 시 자동 알림
- 보안 이벤트 실시간 탐지
- 성능 저하 시 자동 대응 메커니즘
- 장애 발생 시 복구 절차 자동화

이 가이드라인을 따라 데이터베이스를 설계하면 미니 노션의 실시간 협업 요구사항을 만족하면서도 확장 가능하고 안전한 데이터 저장소를 구축할 수 있습니다. 각 원칙은 성능, 보안, 유지보수성을 균형 있게 고려하여 정의되었습니다.